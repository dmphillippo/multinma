---
title: "Example: Social Anxiety"
output: rmarkdown::html_vignette
link-citations: yes
bibliography: ../inst/REFERENCES.bib
params:
  run_tests: FALSE
---


```{r, code=readLines("children/knitr_setup.R"), include=FALSE}
```
```{r, include=FALSE}
set.seed(4783982)
```

```{r, eval = FALSE}
library(multinma)
options(mc.cores = parallel::detectCores())
```
```{r setup, echo = FALSE}
library(multinma)
nc <- switch(tolower(Sys.getenv("_R_CHECK_LIMIT_CORES_")), 
             "true" =, "warn" = 2, 
             parallel::detectCores())
options(mc.cores = nc)
```
This vignette describes the analysis of 101 trials comparing 41 treatments in 17 classes for first-line treatments for social anxiety disorder in adults [@mayo2014psychological]. The data are available in this package as `social_anxiety`:

```{r}
head(social_anxiety)
```

@mayo2014psychological used this dataset to rank treatments and classes. We will demonstrate their approach by incorporating class effects and sharing class standard deviations across classes to replicate these results.

## Setting up the network
We follow Mayo-Wilson et al. by analysing results as standardised mean differences (`y`) with standard error (`se`) therefore we use the function `set_agd_contrast` to set up the network. We make sure to set treatment classes as `classc` and `Waitlist` as the network reference treatment.

```{r}
sa_net <- set_agd_contrast(social_anxiety,
                           study = studyc, 
                           trt = trtc,
                           y = y, 
                           se = se,
                           trt_class = classc,
                           trt_ref = "Waitlist")

sa_net
```

## Class effect models

We fit two (random effects) models:

1. Exchangeable class effects with class sd sharing for the following groups; (`Exercise promotion`, `Self-help no support`), (`SSRI/SNRI`, `NSSA`), (`Psychodynamic psychotherapy`, `Other psychological therapies`)
2. Common class effects 

## Exchangeable class model
We fit a random effects model using the `nma()` function with `trt_effects = "random"`.
We use $\mathrm{N}(0, 100^2)$ prior distributions for the treatment effects $d_k$ and study-specific intercepts $\mu_j$, and a $\textrm{half-N}(5^2)$ prior for the heterogeneity standard deviation $\tau$.
We set `class_effects` as `exchangeable` and use $\mathrm{N}(0.33,0.1)$ for prior_class_sd.

This follows the approach used by [@mayo2014psychological], except that we replace their inverse-Gamma prior with a truncated normal prior for compatibility with the \texttt{multinma} package.

Put something here on the difference between Mayo et al and our analysis. 

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r}
sa_fit_EXclass_RE <- nma(sa_net,
                         trt_effects = "random",
                         prior_trt = normal(0, 100),
                         prior_het = half_normal(5),
                         class_effects = "exchangeable",
                         prior_class_sd = normal(0.33,0.1),
                         class_sd = list(`Exercise and SH no support` = c("Exercise promotion", "Self-help no support"),
                                         `SSRIs and NSSA` = c("SSRI/SNRI", "NSSA"),
                                         `Psychodynamic & Other psychological therapies` = c("Psychodynamic psychotherapy", "Other psychological therapies")
                         )
)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```
