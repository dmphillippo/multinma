---
title: "Example: Newly diagnosed multiple myeloma"
output: rmarkdown::html_vignette
link-citations: yes
bibliography: ../inst/REFERENCES.bib
params:
  run_tests: FALSE
---




```r
library(multinma)
#> For execution on a local, multicore CPU with excess RAM we recommend calling
#> options(mc.cores = parallel::detectCores())
#> 
#> Attaching package: 'multinma'
#> The following objects are masked from 'package:stats':
#> 
#>     dgamma, pgamma, qgamma
library(survival)
library(dplyr)
#> 
#> Attaching package: 'dplyr'
#> The following objects are masked from 'package:stats':
#> 
#>     filter, lag
#> The following objects are masked from 'package:base':
#> 
#>     intersect, setdiff, setequal, union
library(ggplot2)
library(patchwork)
library(loo)
#> This is loo version 2.6.0
#> - Online documentation and vignettes at mc-stan.org/loo
#> - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session.
#> - Windows 10 users: loo may be very slow if 'mc.cores' is set in your .Rprofile file (see https://github.com/stan-dev/loo/issues/94).
```

```r
options(mc.cores = parallel::detectCores())
```


@Leahy2019 present a network of five trials comparing lenalidomide and thalidomide to placebo for newly diagnosed multiple myeloma (NDMM) after autologous stem cell transplant (ASCT).
The outcome of interest is progression free survival (PFS).
Simulated individual patient data (IPD) from three trials are found in the data set `ndmm_ipd`.
These include outcome times, censoring indicators, and covariates for each individual:

```r
head(ndmm_ipd)
#>          study trt       studyf trtf      age iss_stage3 response_cr_vgpr male eventtime status
#> 1 McCarthy2012 Pbo McCarthy2012  Pbo 50.81625          0                1    0 31.106516      1
#> 2 McCarthy2012 Pbo McCarthy2012  Pbo 62.18165          0                0    0  3.299623      0
#> 3 McCarthy2012 Pbo McCarthy2012  Pbo 51.53762          1                1    1 57.400000      0
#> 4 McCarthy2012 Pbo McCarthy2012  Pbo 46.74128          0                1    1 57.400000      0
#> 5 McCarthy2012 Pbo McCarthy2012  Pbo 62.62561          0                1    1 57.400000      0
#> 6 McCarthy2012 Pbo McCarthy2012  Pbo 49.24520          1                1    0 30.714460      0
```

Aggregate data (AgD) consisting of reconstructed event/censoring times from digitized Kaplan-Meier curves and covariate summaries are available on a further two trials, found in the data sets `ndmm_agd` and `ndmm_agd_covs`.

```r
head(ndmm_agd)
#>        study     studyf trt trtf eventtime status
#> 1 Morgan2012 Morgan2012 Pbo  Pbo  18.72575      1
#> 2 Morgan2012 Morgan2012 Pbo  Pbo  63.36000      0
#> 3 Morgan2012 Morgan2012 Pbo  Pbo  34.35726      1
#> 4 Morgan2012 Morgan2012 Pbo  Pbo  10.77826      1
#> 5 Morgan2012 Morgan2012 Pbo  Pbo  63.36000      0
#> 6 Morgan2012 Morgan2012 Pbo  Pbo  14.52966      1

ndmm_agd_covs
#>         study      studyf  trt trtf sample_size  age_min age_iqr_l age_median age_iqr_h  age_max
#> 1 Jackson2019 Jackson2019  Len  Len        1137 17.28246  59.13164   65.76766  72.00756 85.76095
#> 2 Jackson2019 Jackson2019  Pbo  Pbo         864 21.18572  58.30991   65.47402  71.80261 86.23080
#> 3  Morgan2012  Morgan2012  Pbo  Pbo         410 33.88979  58.05696   64.15999  70.44791 84.79372
#> 4  Morgan2012  Morgan2012 Thal Thal         408 38.45127  59.30022   65.48736  71.73597 84.69365
#>   age_mean   age_sd iss_stage3 response_cr_vgpr      male
#> 1 65.16867 8.936962  0.2480211        0.8258575 0.6165347
#> 2 64.62894 9.399272  0.1921296        0.8310185 0.6215278
#> 3 63.92360 9.006311  0.3634146        0.7170732 0.6195122
#> 4 65.59387 8.384686  0.3186275        0.7450980 0.6151961
```

@Phillippo_survival analysed these data using multilevel network meta-regression (ML-NMR), and we recreate these analyses here.

# Study data
First, let us look at Kaplan-Meier plots of the data from each study:

```r
kmdat <- bind_rows(ndmm_ipd, ndmm_agd) %>%
  group_by(studyf, trtf) %>%
  # KM estimate within each study
  group_modify(~with(survfit(Surv(eventtime, event = status) ~ 1, data = .),
                     tibble(time, n.censor, estimate = surv, std.err, upper, lower))) %>%
  # Add S(0) = 1
  group_modify(~add_row(., time = 0, n.censor = 0, estimate = 1, std.err = 0, upper = 1, lower = 1, .before = 0)) %>%
  arrange(studyf, trtf, time)

ggplot(kmdat, aes(x = time, y = estimate, colour = trtf)) +
  geom_step() +
  geom_point(shape = 3, data = function(x) filter(x, n.censor >= 1)) +
  facet_wrap(~studyf) +
  labs(y = "Survival probability", x = "Time") +
  coord_cartesian(ylim = c(0, 1)) +
  theme_multinma() +
  theme(legend.position = "top", legend.box.spacing = unit(0, "lines"))
```

<img src="figure/ndmm-km-data-1.png" style="display: block; margin: auto;" />

We consider adjustment for the following covariates:

 * Age
 * Sex
 * ISS stage, I-II vs. III
 * Response post-ASCT, complete or very good partial response vs. lesser response

The summary distributions of these characteristics in each study are as follows:

```r
bind_rows(
  summarise(ndmm_ipd,
            N = n(),
            age_mean = mean(age), age_sd = sd(age),
            iss_stage3 = mean(iss_stage3),
            response_cr_vgpr = mean(response_cr_vgpr),
            male = mean(male),
            .by = c(studyf, trtf)),
  transmute(ndmm_agd_covs,
            studyf, trtf,
            N = sample_size,
            age_mean, age_sd, iss_stage3, response_cr_vgpr, male)
) %>%
  mutate(across(where(is.double), ~round(., digits = 2)))
#>          studyf trtf    N age_mean age_sd iss_stage3 response_cr_vgpr male
#> 1  McCarthy2012  Pbo  229    57.39   5.56       0.18             0.71 0.55
#> 2  McCarthy2012  Len  231    57.93   6.33       0.27             0.62 0.52
#> 3     Attal2012  Pbo  307    54.22   5.24       0.16             0.54 0.58
#> 4     Attal2012  Len  307    54.35   6.06       0.24             0.55 0.55
#> 5   Palumbo2014  Pbo  125    54.44   8.98       0.12             0.38 0.63
#> 6   Palumbo2014  Len  126    53.90   9.69       0.10             0.42 0.46
#> 7   Jackson2019  Len 1137    65.17   8.94       0.25             0.83 0.62
#> 8   Jackson2019  Pbo  864    64.63   9.40       0.19             0.83 0.62
#> 9    Morgan2012  Pbo  410    63.92   9.01       0.36             0.72 0.62
#> 10   Morgan2012 Thal  408    65.59   8.38       0.32             0.75 0.62
```

# Setup
## Preparing treatment classes
We start by setting up the network for the analysis.
Since we only have IPD on the placebo vs. lenalidomide comparison, and only one AgD study on the placebo vs. thalidomide comparison, we make the shared effect modifier assumption between the two active treatments in order to estimate the effect modifying treatment-covariate interactions for thalidomide [@TSD18,@methods_paper].
Since lenalidomide and thalidomide are both in the same class of treatments, this assumption may be reasonable.

To impose this assumption, we create a treatment class variable for active treatments vs. placebo.

```r
ndmm_ipd$trtclass <- case_match(ndmm_ipd$trtf,
                                "Pbo" ~ "Placebo",
                                c("Len", "Thal") ~ "Active")

ndmm_agd$trtclass <- case_match(ndmm_agd$trtf,
                                "Pbo" ~ "Placebo",
                                c("Len", "Thal") ~ "Active")
```


## Setting up the network
We then set up the network using the `set_ipd()`, `set_agd_surv()`, and `combine_network()` functions.
Since we have survival data in the form of event/censoring times and censoring indicators, we use the `Surv` argument to the `set_*()` functions to set up the outcome data using the usual `survival::Surv()` function.
The AgD are set up in a similar fashion to the IPD, except that we only have summary covariate information (in the data frame `ndmm_agd_covs`) which is included using the `covariates` argument.
The data frame passed to `covariates` must have matching study and treatment columns to the outcome data set (`ndmm_agd`), in this case `studyf` and `trtf` respectively, one row per arm, so that the covariate information can be matched to the corresponding arms in the outcome data.
The IPD and AgD are then combined into a single network using `combine_network()`.

```r
ndmm_net <- combine_network(
  set_ipd(ndmm_ipd,
          study = studyf,
          trt = trtf,
          trt_class = trtclass,
          Surv = Surv(eventtime, status)),
  set_agd_surv(ndmm_agd,
               study = studyf,
               trt = trtf,
               trt_class = trtclass,
               Surv = Surv(eventtime, status),
               covariates = ndmm_agd_covs)
)
```

## Adding numerical integration for ML-NMR
To perform ML-NMR, we need to create numerical integration points for the joint covariate distributions in each AgD study.
These are used to integrate (i.e. average) the individual-level model over the joint covariate distribution to form the aggregate-level model.
This is done using the `add_integration()` function, and for each covariate we specify the marginal distribution using the `distr()` function.
Since age is skewed, we use a gamma distribution for this covariate; the remaining covariates are all binary and so are given Bernoulli distributions.
This procedure also requires information on the correlations between covariates.
If known, these can be specified using the `cor` argument.
However, by default the weighted average correlations from the IPD studies will be used.

```r
ndmm_net <- add_integration(ndmm_net,
                            age = distr(qgamma, mean = age_mean, sd = age_sd),
                            iss_stage3 = distr(qbern, iss_stage3),
                            response_cr_vgpr = distr(qbern, response_cr_vgpr),
                            male = distr(qbern, male))
#> Using weighted average correlation matrix computed from IPD studies.

ndmm_net
#> A network with 3 IPD studies, and 2 AgD studies (arm-based).
#> 
#> ------------------------------------------------------------------- IPD studies ---- 
#>  Study        Treatment arms
#>  Attal2012    2: Pbo | Len  
#>  McCarthy2012 2: Pbo | Len  
#>  Palumbo2014  2: Pbo | Len  
#> 
#>  Outcome type: survival
#> ------------------------------------------------------- AgD studies (arm-based) ---- 
#>  Study       Treatment arms
#>  Jackson2019 2: Pbo | Len  
#>  Morgan2012  2: Pbo | Thal 
#> 
#>  Outcome type: survival
#> ------------------------------------------------------------------------------------
#> Total number of treatments: 3, in 2 classes
#> Total number of studies: 5
#> Reference treatment is: Pbo
#> Network is connected
#> 
#> --------------------------------------------------------- Numerical integration ---- 
#> Numerical integration points available for 4 covariates: 
#>   age iss_stage3 response_cr_vgpr male
#> Number of numerical integration points: 64
```

## Network plot
We can plot the network diagram using the `plot()` method.

```r
plot(ndmm_net,
    weight_nodes = TRUE,
    weight_edges = TRUE,
    # Nudge treatment labels away from nodes
    nudge = 0.1,
    # Manual layout
    layout = data.frame(x = c(0, -1, 1),
                        y = c(-0.5, 0, 0))) +
  guides(edge_colour = guide_legend(override.aes = list(edge_width = 2))) +
  theme(legend.position = "bottom", legend.direction = "vertical")
```

<img src="figure/ndmm-network-1.png" style="display: block; margin: auto;" />

# ML-NMR models with M-spline baseline hazards
We fit a proportional hazards survival model with cubic M-splines on the baseline hazard [@Brilleman2020,@Phillippo_survival].
This allows the baseline hazard to flexibly follow any shape that the baseline hazard may take.

## Choosing the number of knots
ML-NMR models are fit using the `nma()` function, and we specify that a M-spline baseline hazard should be used with `likelihood = "mspline"`.

Fitting spline models requires the user to specify the number and location of the knots.
By default, three internal knots are used (`n_knots = 3`) which are placed at evenly spaced quantiles on the observed event times within each study (i.e. at the 25%, 50%, and 75% quantiles with 3 internal knots).
The number of knots can be changed using the `n_knots` argument, or custom knot locations can be specified using the `knots` argument.
The `nma()` function will always place boundary knots at the earliest entry time into the study (0 with no delayed entry) and at the maximum event/censoring time.

By default, the `nma()` function will fit a cubic M-spline (`mspline_degree = 3`).
Piecewise-constant hazards (i.e. piecewise exponential hazards) are a special case with degree 0 splines, specified using `likelihood = "pexp"` (which is equivalent to `mspline_degree = 0`).

We specify a regression model using the `regression` argument which includes main effects of covariates (prognostic effects)  and treatment-covariate interactions (effect modifier interactions) for each covariate.
We place vague $\operatorname{N}(0, 100^2)$ priors on each of the parameters in the linear predictor, and a $\operatorname{Dirichlet}(1)$ prior distribution for the spline coefficients which is uniform over the unit simplex.
Using the QR decomposition (`QR = TRUE`) can greatly increase sampling efficiency for regression models, and we also reduce the `max_treedepth` of the Stan sampler to speed up warm-up time.

We fit models with 1, 2, and 3 internal knots, and we will then choose the number of knots using the leave-one-out information criterion (LOOIC).


```r
ndmm_fit_1kt <- nma(ndmm_net,
                    regression = ~(age + iss_stage3 + response_cr_vgpr + male)*.trt,
                    likelihood = "mspline",
                    n_knots = 1,
                    prior_intercept = normal(0, 100),
                    prior_trt = normal(0, 100),
                    prior_reg = normal(0, 100),
                    prior_aux = dirichlet(1),
                    QR = TRUE,
                    # Reducing max_treedepth can speed up warm-up, but
                    # increase if max_treedepth errors occur
                    control = list(max_treedepth = 6))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_1kt
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Regression model: ~(age + iss_stage3 + response_cr_vgpr + male) * .trt.
#> Centred covariates at the following overall mean values:
#>              age       iss_stage3 response_cr_vgpr             male 
#>       61.6558571        0.2297184        0.7314265        0.6020451 
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                                             mean se_mean   sd      2.5%       25%       50%
#> beta[age]                                   0.08    0.00 0.01      0.06      0.07      0.08
#> beta[iss_stage3]                            0.36    0.00 0.13      0.09      0.27      0.36
#> beta[response_cr_vgpr]                     -0.14    0.00 0.10     -0.33     -0.20     -0.14
#> beta[male]                                  0.01    0.00 0.10     -0.19     -0.06      0.01
#> beta[age:.trtclassActive]                  -0.02    0.00 0.01     -0.03     -0.02     -0.02
#> beta[iss_stage3:.trtclassActive]            0.20    0.00 0.17     -0.14      0.08      0.20
#> beta[response_cr_vgpr:.trtclassActive]      0.20    0.00 0.14     -0.07      0.10      0.20
#> beta[male:.trtclassActive]                  0.13    0.00 0.15     -0.17      0.03      0.13
#> d[Len]                                     -0.67    0.00 0.05     -0.77     -0.71     -0.67
#> d[Thal]                                    -0.20    0.00 0.11     -0.42     -0.27     -0.20
#> lp__                                   -12422.83    0.12 4.54 -12432.71 -12425.68 -12422.41
#> scoef[Attal2012, 1]                         0.03    0.00 0.01      0.01      0.02      0.03
#> scoef[Attal2012, 2]                         0.18    0.00 0.05      0.07      0.14      0.17
#> scoef[Attal2012, 3]                         0.38    0.00 0.10      0.19      0.32      0.38
#> scoef[Attal2012, 4]                         0.20    0.00 0.09      0.03      0.13      0.19
#> scoef[Attal2012, 5]                         0.22    0.00 0.05      0.13      0.19      0.22
#> scoef[McCarthy2012, 1]                      0.01    0.00 0.01      0.00      0.00      0.00
#> scoef[McCarthy2012, 2]                      0.28    0.00 0.04      0.20      0.25      0.28
#> scoef[McCarthy2012, 3]                      0.17    0.00 0.09      0.02      0.10      0.16
#> scoef[McCarthy2012, 4]                      0.31    0.00 0.11      0.08      0.23      0.31
#> scoef[McCarthy2012, 5]                      0.23    0.00 0.07      0.09      0.18      0.23
#> scoef[Palumbo2014, 1]                       0.01    0.00 0.01      0.00      0.00      0.01
#> scoef[Palumbo2014, 2]                       0.39    0.00 0.07      0.26      0.34      0.39
#> scoef[Palumbo2014, 3]                       0.20    0.00 0.11      0.02      0.12      0.20
#> scoef[Palumbo2014, 4]                       0.18    0.00 0.11      0.01      0.09      0.17
#> scoef[Palumbo2014, 5]                       0.21    0.00 0.08      0.06      0.15      0.21
#> scoef[Jackson2019, 1]                       0.04    0.00 0.01      0.03      0.03      0.04
#> scoef[Jackson2019, 2]                       0.32    0.00 0.03      0.25      0.29      0.32
#> scoef[Jackson2019, 3]                       0.23    0.00 0.06      0.11      0.18      0.23
#> scoef[Jackson2019, 4]                       0.22    0.00 0.07      0.09      0.18      0.22
#> scoef[Jackson2019, 5]                       0.20    0.00 0.04      0.12      0.17      0.20
#> scoef[Morgan2012, 1]                        0.02    0.00 0.01      0.01      0.02      0.02
#> scoef[Morgan2012, 2]                        0.45    0.00 0.04      0.37      0.43      0.45
#> scoef[Morgan2012, 3]                        0.10    0.00 0.07      0.00      0.05      0.09
#> scoef[Morgan2012, 4]                        0.34    0.00 0.08      0.16      0.29      0.35
#> scoef[Morgan2012, 5]                        0.08    0.00 0.05      0.01      0.04      0.08
#>                                              75%     97.5% n_eff Rhat
#> beta[age]                                   0.08      0.09  4125 1.00
#> beta[iss_stage3]                            0.45      0.60  8460 1.00
#> beta[response_cr_vgpr]                     -0.07      0.06  7319 1.00
#> beta[male]                                  0.07      0.21  9061 1.00
#> beta[age:.trtclassActive]                  -0.01      0.00  4984 1.00
#> beta[iss_stage3:.trtclassActive]            0.32      0.54 10231 1.00
#> beta[response_cr_vgpr:.trtclassActive]      0.30      0.48  6680 1.00
#> beta[male:.trtclassActive]                  0.23      0.43  6211 1.00
#> d[Len]                                     -0.63     -0.56  4645 1.00
#> d[Thal]                                    -0.13      0.01  4208 1.01
#> lp__                                   -12419.56 -12415.14  1403 1.00
#> scoef[Attal2012, 1]                         0.04      0.06  3835 1.00
#> scoef[Attal2012, 2]                         0.21      0.28  3107 1.00
#> scoef[Attal2012, 3]                         0.45      0.57  2743 1.00
#> scoef[Attal2012, 4]                         0.26      0.39  2986 1.00
#> scoef[Attal2012, 5]                         0.25      0.31  3693 1.00
#> scoef[McCarthy2012, 1]                      0.01      0.02  6817 1.00
#> scoef[McCarthy2012, 2]                      0.31      0.37  3650 1.00
#> scoef[McCarthy2012, 3]                      0.24      0.36  2881 1.00
#> scoef[McCarthy2012, 4]                      0.39      0.52  2946 1.00
#> scoef[McCarthy2012, 5]                      0.28      0.38  3514 1.00
#> scoef[Palumbo2014, 1]                       0.02      0.04  5219 1.00
#> scoef[Palumbo2014, 2]                       0.44      0.53  4516 1.00
#> scoef[Palumbo2014, 3]                       0.27      0.41  3449 1.00
#> scoef[Palumbo2014, 4]                       0.27      0.42  3763 1.00
#> scoef[Palumbo2014, 5]                       0.27      0.38  4682 1.00
#> scoef[Jackson2019, 1]                       0.04      0.05  1789 1.01
#> scoef[Jackson2019, 2]                       0.34      0.38  3085 1.00
#> scoef[Jackson2019, 3]                       0.27      0.35  2521 1.00
#> scoef[Jackson2019, 4]                       0.27      0.35  2601 1.00
#> scoef[Jackson2019, 5]                       0.22      0.27  3485 1.00
#> scoef[Morgan2012, 1]                        0.03      0.04  6058 1.00
#> scoef[Morgan2012, 2]                        0.49      0.54  3772 1.00
#> scoef[Morgan2012, 3]                        0.14      0.26  3793 1.00
#> scoef[Morgan2012, 4]                        0.40      0.48  4936 1.00
#> scoef[Morgan2012, 5]                        0.11      0.18  5093 1.00
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 18:49:17 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).

ndmm_fit_2kt <- nma(ndmm_net,
                    regression = ~(age + iss_stage3 + response_cr_vgpr + male)*.trt,
                    likelihood = "mspline",
                    n_knots = 2,
                    prior_intercept = normal(0, 100),
                    prior_trt = normal(0, 100),
                    prior_reg = normal(0, 100),
                    prior_aux = dirichlet(1),
                    QR = TRUE,
                    # Reducing max_treedepth can speed up warm-up, but
                    # increase if max_treedepth errors occur
                    control = list(max_treedepth = 6))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_2kt
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Regression model: ~(age + iss_stage3 + response_cr_vgpr + male) * .trt.
#> Centred covariates at the following overall mean values:
#>              age       iss_stage3 response_cr_vgpr             male 
#>       61.6558571        0.2297184        0.7314265        0.6020451 
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                                             mean se_mean   sd      2.5%       25%       50%
#> beta[age]                                   0.08    0.00 0.01      0.06      0.07      0.08
#> beta[iss_stage3]                            0.35    0.00 0.13      0.08      0.26      0.35
#> beta[response_cr_vgpr]                     -0.13    0.00 0.10     -0.33     -0.20     -0.13
#> beta[male]                                  0.01    0.00 0.10     -0.20     -0.07      0.01
#> beta[age:.trtclassActive]                  -0.02    0.00 0.01     -0.03     -0.02     -0.02
#> beta[iss_stage3:.trtclassActive]            0.20    0.00 0.18     -0.15      0.07      0.20
#> beta[response_cr_vgpr:.trtclassActive]      0.20    0.00 0.14     -0.07      0.11      0.20
#> beta[male:.trtclassActive]                  0.13    0.00 0.15     -0.16      0.03      0.13
#> d[Len]                                     -0.67    0.00 0.05     -0.77     -0.70     -0.67
#> d[Thal]                                    -0.20    0.00 0.11     -0.40     -0.27     -0.20
#> lp__                                   -12438.01    0.14 4.81 -12448.46 -12441.00 -12437.62
#> scoef[Attal2012, 1]                         0.02    0.00 0.01      0.00      0.01      0.01
#> scoef[Attal2012, 2]                         0.11    0.00 0.03      0.05      0.08      0.11
#> scoef[Attal2012, 3]                         0.21    0.00 0.07      0.08      0.16      0.21
#> scoef[Attal2012, 4]                         0.39    0.00 0.08      0.22      0.34      0.39
#> scoef[Attal2012, 5]                         0.10    0.00 0.06      0.00      0.05      0.09
#> scoef[Attal2012, 6]                         0.19    0.00 0.04      0.11      0.16      0.19
#> scoef[McCarthy2012, 1]                      0.00    0.00 0.00      0.00      0.00      0.00
#> scoef[McCarthy2012, 2]                      0.12    0.00 0.03      0.07      0.10      0.12
#> scoef[McCarthy2012, 3]                      0.20    0.00 0.07      0.07      0.15      0.19
#> scoef[McCarthy2012, 4]                      0.30    0.00 0.09      0.11      0.24      0.30
#> scoef[McCarthy2012, 5]                      0.17    0.00 0.10      0.02      0.09      0.16
#> scoef[McCarthy2012, 6]                      0.21    0.00 0.07      0.07      0.16      0.21
#> scoef[Palumbo2014, 1]                       0.01    0.00 0.01      0.00      0.00      0.00
#> scoef[Palumbo2014, 2]                       0.15    0.00 0.04      0.09      0.12      0.15
#> scoef[Palumbo2014, 3]                       0.27    0.00 0.09      0.10      0.20      0.26
#> scoef[Palumbo2014, 4]                       0.27    0.00 0.11      0.04      0.19      0.27
#> scoef[Palumbo2014, 5]                       0.12    0.00 0.09      0.00      0.05      0.10
#> scoef[Palumbo2014, 6]                       0.19    0.00 0.08      0.05      0.14      0.19
#> scoef[Jackson2019, 1]                       0.02    0.00 0.00      0.01      0.02      0.02
#> scoef[Jackson2019, 2]                       0.11    0.00 0.01      0.08      0.10      0.11
#> scoef[Jackson2019, 3]                       0.29    0.00 0.04      0.21      0.26      0.28
#> scoef[Jackson2019, 4]                       0.23    0.00 0.06      0.12      0.20      0.24
#> scoef[Jackson2019, 5]                       0.18    0.00 0.06      0.07      0.14      0.18
#> scoef[Jackson2019, 6]                       0.16    0.00 0.03      0.10      0.14      0.16
#> scoef[Morgan2012, 1]                        0.01    0.00 0.01      0.00      0.01      0.01
#> scoef[Morgan2012, 2]                        0.13    0.00 0.02      0.09      0.12      0.13
#> scoef[Morgan2012, 3]                        0.37    0.00 0.05      0.26      0.33      0.37
#> scoef[Morgan2012, 4]                        0.15    0.00 0.08      0.01      0.09      0.14
#> scoef[Morgan2012, 5]                        0.28    0.00 0.08      0.12      0.23      0.29
#> scoef[Morgan2012, 6]                        0.06    0.00 0.04      0.00      0.03      0.06
#>                                              75%     97.5% n_eff Rhat
#> beta[age]                                   0.08      0.09  4785    1
#> beta[iss_stage3]                            0.44      0.61  9636    1
#> beta[response_cr_vgpr]                     -0.07      0.06  7143    1
#> beta[male]                                  0.08      0.21 11638    1
#> beta[age:.trtclassActive]                  -0.01      0.00  5969    1
#> beta[iss_stage3:.trtclassActive]            0.33      0.55  9439    1
#> beta[response_cr_vgpr:.trtclassActive]      0.29      0.48  6518    1
#> beta[male:.trtclassActive]                  0.23      0.42  9271    1
#> d[Len]                                     -0.63     -0.56  6105    1
#> d[Thal]                                    -0.13      0.01  6436    1
#> lp__                                   -12434.68 -12429.63  1236    1
#> scoef[Attal2012, 1]                         0.02      0.04  3682    1
#> scoef[Attal2012, 2]                         0.13      0.17  2921    1
#> scoef[Attal2012, 3]                         0.25      0.34  2594    1
#> scoef[Attal2012, 4]                         0.44      0.53  2511    1
#> scoef[Attal2012, 5]                         0.14      0.24  3383    1
#> scoef[Attal2012, 6]                         0.21      0.27  4507    1
#> scoef[McCarthy2012, 1]                      0.00      0.01  6677    1
#> scoef[McCarthy2012, 2]                      0.14      0.18  3644    1
#> scoef[McCarthy2012, 3]                      0.24      0.33  2551    1
#> scoef[McCarthy2012, 4]                      0.36      0.47  2414    1
#> scoef[McCarthy2012, 5]                      0.23      0.39  3211    1
#> scoef[McCarthy2012, 6]                      0.26      0.35  4569    1
#> scoef[Palumbo2014, 1]                       0.01      0.02  6325    1
#> scoef[Palumbo2014, 2]                       0.17      0.22  5110    1
#> scoef[Palumbo2014, 3]                       0.33      0.44  3219    1
#> scoef[Palumbo2014, 4]                       0.34      0.48  2887    1
#> scoef[Palumbo2014, 5]                       0.17      0.32  4497    1
#> scoef[Palumbo2014, 6]                       0.25      0.35  5667    1
#> scoef[Jackson2019, 1]                       0.02      0.03  6003    1
#> scoef[Jackson2019, 2]                       0.12      0.14  3181    1
#> scoef[Jackson2019, 3]                       0.31      0.36  3327    1
#> scoef[Jackson2019, 4]                       0.27      0.35  2815    1
#> scoef[Jackson2019, 5]                       0.22      0.30  3409    1
#> scoef[Jackson2019, 6]                       0.19      0.23  4284    1
#> scoef[Morgan2012, 1]                        0.01      0.02  4714    1
#> scoef[Morgan2012, 2]                        0.14      0.17  4716    1
#> scoef[Morgan2012, 3]                        0.40      0.46  3378    1
#> scoef[Morgan2012, 4]                        0.20      0.32  3326    1
#> scoef[Morgan2012, 5]                        0.34      0.42  3824    1
#> scoef[Morgan2012, 6]                        0.09      0.16  4608    1
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 19:38:00 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).

ndmm_fit_3kt <- nma(ndmm_net,
                    regression = ~(age + iss_stage3 + response_cr_vgpr + male)*.trt,
                    likelihood = "mspline",
                    n_knots = 3,
                    prior_intercept = normal(0, 100),
                    prior_trt = normal(0, 100),
                    prior_reg = normal(0, 100),
                    prior_aux = dirichlet(1),
                    QR = TRUE,
                    # Reducing max_treedepth can speed up warm-up, but
                    # increase if max_treedepth errors occur
                    control = list(max_treedepth = 6))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_3kt
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Regression model: ~(age + iss_stage3 + response_cr_vgpr + male) * .trt.
#> Centred covariates at the following overall mean values:
#>              age       iss_stage3 response_cr_vgpr             male 
#>       61.6558571        0.2297184        0.7314265        0.6020451 
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                                             mean se_mean   sd      2.5%       25%       50%
#> beta[age]                                   0.08    0.00 0.01      0.06      0.07      0.08
#> beta[iss_stage3]                            0.35    0.00 0.13      0.08      0.26      0.35
#> beta[response_cr_vgpr]                     -0.14    0.00 0.10     -0.33     -0.20     -0.14
#> beta[male]                                  0.01    0.00 0.10     -0.19     -0.06      0.01
#> beta[age:.trtclassActive]                  -0.02    0.00 0.01     -0.03     -0.02     -0.02
#> beta[iss_stage3:.trtclassActive]            0.20    0.00 0.17     -0.13      0.08      0.20
#> beta[response_cr_vgpr:.trtclassActive]      0.20    0.00 0.14     -0.07      0.11      0.20
#> beta[male:.trtclassActive]                  0.13    0.00 0.15     -0.16      0.02      0.13
#> d[Len]                                     -0.67    0.00 0.05     -0.77     -0.70     -0.67
#> d[Thal]                                    -0.19    0.00 0.11     -0.40     -0.27     -0.19
#> lp__                                   -12455.31    0.14 5.25 -12466.37 -12458.71 -12454.92
#> scoef[Attal2012, 1]                         0.01    0.00 0.01      0.00      0.01      0.01
#> scoef[Attal2012, 2]                         0.07    0.00 0.03      0.02      0.05      0.07
#> scoef[Attal2012, 3]                         0.13    0.00 0.04      0.04      0.10      0.13
#> scoef[Attal2012, 4]                         0.29    0.00 0.06      0.17      0.25      0.29
#> scoef[Attal2012, 5]                         0.25    0.00 0.07      0.11      0.20      0.25
#> scoef[Attal2012, 6]                         0.09    0.00 0.06      0.01      0.04      0.08
#> scoef[Attal2012, 7]                         0.16    0.00 0.04      0.09      0.13      0.16
#> scoef[McCarthy2012, 1]                      0.00    0.00 0.00      0.00      0.00      0.00
#> scoef[McCarthy2012, 2]                      0.05    0.00 0.02      0.01      0.04      0.05
#> scoef[McCarthy2012, 3]                      0.18    0.00 0.04      0.10      0.15      0.18
#> scoef[McCarthy2012, 4]                      0.15    0.00 0.06      0.03      0.10      0.15
#> scoef[McCarthy2012, 5]                      0.32    0.00 0.08      0.16      0.26      0.32
#> scoef[McCarthy2012, 6]                      0.10    0.00 0.07      0.00      0.04      0.08
#> scoef[McCarthy2012, 7]                      0.21    0.00 0.07      0.08      0.16      0.21
#> scoef[Palumbo2014, 1]                       0.00    0.00 0.00      0.00      0.00      0.00
#> scoef[Palumbo2014, 2]                       0.08    0.00 0.03      0.03      0.07      0.08
#> scoef[Palumbo2014, 3]                       0.13    0.00 0.05      0.03      0.09      0.13
#> scoef[Palumbo2014, 4]                       0.29    0.00 0.09      0.10      0.23      0.29
#> scoef[Palumbo2014, 5]                       0.19    0.00 0.10      0.02      0.12      0.19
#> scoef[Palumbo2014, 6]                       0.11    0.00 0.08      0.00      0.05      0.10
#> scoef[Palumbo2014, 7]                       0.18    0.00 0.08      0.04      0.12      0.18
#> scoef[Jackson2019, 1]                       0.01    0.00 0.00      0.01      0.01      0.01
#> scoef[Jackson2019, 2]                       0.07    0.00 0.01      0.05      0.06      0.07
#> scoef[Jackson2019, 3]                       0.13    0.00 0.02      0.09      0.11      0.13
#> scoef[Jackson2019, 4]                       0.29    0.00 0.04      0.22      0.26      0.29
#> scoef[Jackson2019, 5]                       0.18    0.00 0.05      0.07      0.14      0.18
#> scoef[Jackson2019, 6]                       0.18    0.00 0.05      0.08      0.15      0.18
#> scoef[Jackson2019, 7]                       0.13    0.00 0.03      0.08      0.11      0.13
#> scoef[Morgan2012, 1]                        0.01    0.00 0.00      0.00      0.00      0.01
#> scoef[Morgan2012, 2]                        0.07    0.00 0.01      0.04      0.06      0.07
#> scoef[Morgan2012, 3]                        0.16    0.00 0.03      0.11      0.14      0.16
#> scoef[Morgan2012, 4]                        0.32    0.00 0.05      0.21      0.28      0.32
#> scoef[Morgan2012, 5]                        0.15    0.00 0.08      0.02      0.10      0.15
#> scoef[Morgan2012, 6]                        0.24    0.00 0.07      0.10      0.20      0.25
#> scoef[Morgan2012, 7]                        0.05    0.00 0.04      0.00      0.02      0.05
#>                                              75%     97.5% n_eff Rhat
#> beta[age]                                   0.08      0.09  4506    1
#> beta[iss_stage3]                            0.44      0.61  6426    1
#> beta[response_cr_vgpr]                     -0.07      0.07  7209    1
#> beta[male]                                  0.07      0.21  8857    1
#> beta[age:.trtclassActive]                  -0.01      0.00  5260    1
#> beta[iss_stage3:.trtclassActive]            0.32      0.55  6366    1
#> beta[response_cr_vgpr:.trtclassActive]      0.30      0.48  6422    1
#> beta[male:.trtclassActive]                  0.23      0.42  8144    1
#> d[Len]                                     -0.63     -0.56  5030    1
#> d[Thal]                                    -0.12      0.02  5503    1
#> lp__                                   -12451.50 -12446.12  1382    1
#> scoef[Attal2012, 1]                         0.02      0.03  3352    1
#> scoef[Attal2012, 2]                         0.09      0.12  2388    1
#> scoef[Attal2012, 3]                         0.15      0.21  2194    1
#> scoef[Attal2012, 4]                         0.34      0.42  2340    1
#> scoef[Attal2012, 5]                         0.30      0.37  2473    1
#> scoef[Attal2012, 6]                         0.13      0.22  3104    1
#> scoef[Attal2012, 7]                         0.19      0.24  4230    1
#> scoef[McCarthy2012, 1]                      0.00      0.01  6289    1
#> scoef[McCarthy2012, 2]                      0.06      0.09  2993    1
#> scoef[McCarthy2012, 3]                      0.21      0.26  2593    1
#> scoef[McCarthy2012, 4]                      0.19      0.28  2638    1
#> scoef[McCarthy2012, 5]                      0.37      0.46  2649    1
#> scoef[McCarthy2012, 6]                      0.14      0.27  3040    1
#> scoef[McCarthy2012, 7]                      0.25      0.33  5255    1
#> scoef[Palumbo2014, 1]                       0.01      0.02  6677    1
#> scoef[Palumbo2014, 2]                       0.10      0.14  4492    1
#> scoef[Palumbo2014, 3]                       0.17      0.25  3415    1
#> scoef[Palumbo2014, 4]                       0.36      0.47  2937    1
#> scoef[Palumbo2014, 5]                       0.26      0.40  2979    1
#> scoef[Palumbo2014, 6]                       0.17      0.30  4765    1
#> scoef[Palumbo2014, 7]                       0.23      0.34  5738    1
#> scoef[Jackson2019, 1]                       0.02      0.02  4062    1
#> scoef[Jackson2019, 2]                       0.08      0.09  3391    1
#> scoef[Jackson2019, 3]                       0.14      0.17  2978    1
#> scoef[Jackson2019, 4]                       0.31      0.36  3043    1
#> scoef[Jackson2019, 5]                       0.22      0.28  2885    1
#> scoef[Jackson2019, 6]                       0.22      0.29  3491    1
#> scoef[Jackson2019, 7]                       0.15      0.20  4055    1
#> scoef[Morgan2012, 1]                        0.01      0.02  4940    1
#> scoef[Morgan2012, 2]                        0.08      0.10  3823    1
#> scoef[Morgan2012, 3]                        0.18      0.22  3920    1
#> scoef[Morgan2012, 4]                        0.35      0.42  3178    1
#> scoef[Morgan2012, 5]                        0.20      0.31  2888    1
#> scoef[Morgan2012, 6]                        0.29      0.37  3457    1
#> scoef[Morgan2012, 7]                        0.07      0.13  5032    1
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 20:28:03 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).
```

We then compare the LOOIC, using the `loo` package.

```r
(ndmm_fit_1kt_loo <- loo(ndmm_fit_1kt))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12385.5 116.2
#> p_loo        31.8   0.8
#> looic     24770.9 232.5
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

(ndmm_fit_2kt_loo <- loo(ndmm_fit_2kt))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12386.1 116.2
#> p_loo        35.9   0.9
#> looic     24772.2 232.4
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

(ndmm_fit_3kt_loo <- loo(ndmm_fit_3kt))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12388.2 116.2
#> p_loo        40.1   0.9
#> looic     24776.3 232.5
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

loo_compare(list("1 knot" = ndmm_fit_1kt_loo,
                 "2 knots" = ndmm_fit_2kt_loo,
                 "3 knots" = ndmm_fit_3kt_loo))
#>         elpd_diff se_diff
#> 1 knot   0.0       0.0   
#> 2 knots -0.7       2.1   
#> 3 knots -2.7       2.7   
```

The model with a single internal knot at the median uncensored survival time has the lowest LOOIC (highest ELPD).
Increasing the number of knots does not improve overall model fit in this case.

It is also important to check the model fit within each study, to check that no single study has a better fit with a larger number of knots which could be washed out by the increased model complexity in other studies.

```r
studies_all <- c(ndmm_ipd$study, ndmm_agd$study)
cbind(
  `1 knot` = by(ndmm_fit_1kt_loo$pointwise[, "looic"], studies_all, sum),
  `2 knots` = by(ndmm_fit_2kt_loo$pointwise[, "looic"], studies_all, sum),
  `3 knots` = by(ndmm_fit_3kt_loo$pointwise[, "looic"], studies_all, sum)
)
#>                 1 knot   2 knots   3 knots
#> Attal2012     3342.043  3341.188  3342.966
#> Jackson2019  12394.107 12395.073 12396.222
#> McCarthy2012  2723.239  2724.039  2723.232
#> Morgan2012    4981.445  4981.976  4983.157
#> Palumbo2014   1330.072  1329.954  1330.747
```

We conclude that 1 knot is sufficient for all studies.


## Ploting hazards
Let us look at the estimated hazard functions under each model with increasing numbers of knots.

By default, the `predict()` function with `type = "hazard"` will produce plots of the population-average marginal hazards (`level = "aggregate"`, which is the default).
These can then be plotted using the `plot()` function.
We combine the plots into one grid using the `patchwork` package.

```r
mhp1 <- plot(predict(ndmm_fit_1kt, type = "hazard", level = "aggregate"))

mhp2 <- plot(predict(ndmm_fit_2kt, type = "hazard", level = "aggregate"))

mhp3 <- plot(predict(ndmm_fit_3kt, type = "hazard", level = "aggregate"))

# Combining these into a single plot using patchwork
mhp1 + facet_grid(rows = vars("1 knot"), cols = vars(Study)) +
  mhp2 + facet_grid(rows = vars("2 knots"), cols = vars(Study)) +
  mhp3 + facet_grid(rows = vars("3 knots"), cols = vars(Study)) +
  plot_layout(ncol = 1, guides = "collect") &
  theme(legend.position = "top", legend.box.spacing = unit(0, "lines"))
```

<img src="figure/ndmm-marginal-hazards-1.png" style="display: block; margin: auto;" />

We see that with increasing numbers of knots the marginal hazards become increasingly "wiggly", which in this case is overfitting.

We can also look at the individual-level baseline hazards.
This is again possible using the `predict()` function, this time with `level = "individual"`.
Since we want to show the baseline hazard for the reference level of the covariates, we'll create a data frame to pass to `predict()` as `newdata`.

```r
refdat <- tibble(study = ndmm_net$studies,
                 age = ndmm_fit_1kt$xbar["age"],
                 iss_stage3 = 0,
                 response_cr_vgpr = 0,
                 male = 0)
```

Since we are providing a new data frame for prediction, we also need to provide the times to predict at and the distributions of the baseline (intercept) and auxiliary (spline coefficient) parameters.
We will predict at evenly spaced times between time 0 and the last event/censoring time in each study.
We specify a named list of the study names for both `baseline` and `aux`, to use the posterior distributions from each study for these parameters.

```r
# At evenly spaced times between the boundary knots
tdat <- purrr::imap_dfr(ndmm_fit_1kt$basis,
                        ~tibble(study = factor(.y, levels = ndmm_net$studies),
                                lower = attr(.x, "Boundary.knots")[1],
                                upper = attr(.x, "Boundary.knots")[2],
                                times = seq(lower, upper, length = 50)))

refdat <- left_join(refdat, tdat, by = "study")

studies <- as.list(setNames(nm = levels(ndmm_net$studies)))
```

Then we produce the predictions, plot and combine using `patchwork`.

```r
bhp1 <- plot(predict(ndmm_fit_1kt, type = "hazard", level = "individual",
                    newdata = refdat, study = study, times = times,
                    baseline = studies, aux = studies))

bhp2 <- plot(predict(ndmm_fit_2kt, type = "hazard", level = "individual",
                    newdata = refdat, study = study, times = times,
                    baseline = studies, aux = studies))

bhp3 <- plot(predict(ndmm_fit_3kt, type = "hazard", level = "individual",
                    newdata = refdat, study = study, times = times,
                    baseline = studies, aux = studies))

# Combining these into a single plot using patchwork
bhp1 + facet_grid(rows = vars("1 knot"), cols = vars(Study)) +
  bhp2 + facet_grid(rows = vars("2 knots"), cols = vars(Study)) +
  bhp3 + facet_grid(rows = vars("3 knots"), cols = vars(Study)) +
  plot_layout(ncol = 1, guides = "collect") &
  theme(legend.position = "top", legend.box.spacing = unit(0, "lines"))
```

<img src="figure/ndmm-baseline-hazards-1.png" style="display: block; margin: auto;" />

Again, we see that as the number of knots increases the baseline hazards get more "wiggly".
As noted above, based on LOOIC the model with 1 internal knot is sufficient here.

# Assessing the proportional hazards assumption

We can relax and assess the proportional hazards (PH) assumption by allowing the spline coefficients to vary between treatment arms within each study.
This is achieved using the `aux_by` argument, with `aux_by = c(.study, .trt)`.
Technically, `aux_by = .study` is always assumed in order to respect randomisation (analogous to stratifying the intercept terms in a NMA by study), and we could simply write `aux_by = .trt`; but we choose to make the stratification by study explicit in this instance.

```r
ndmm_fit_nph <- nma(ndmm_net,
                    regression = ~(age + iss_stage3 + response_cr_vgpr + male)*.trt,
                    likelihood = "mspline",
                    n_knots = 1,
                    prior_intercept = normal(0, 100),
                    prior_trt = normal(0, 100),
                    prior_reg = normal(0, 100),
                    prior_aux = dirichlet(1),
                    aux_by = c(.study, .trt),
                    QR = TRUE,
                    # Reducing max_treedepth can speed up warm-up, but
                    # increase if max_treedepth errors occur
                    control = list(max_treedepth = 6))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_nph
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Regression model: ~(age + iss_stage3 + response_cr_vgpr + male) * .trt.
#> Centred covariates at the following overall mean values:
#>              age       iss_stage3 response_cr_vgpr             male 
#>       61.6558571        0.2297184        0.7314265        0.6020451 
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                                             mean se_mean   sd      2.5%       25%       50%
#> beta[age]                                   0.07    0.00 0.01      0.06      0.07      0.07
#> beta[iss_stage3]                            0.33    0.00 0.13      0.07      0.24      0.34
#> beta[response_cr_vgpr]                     -0.11    0.00 0.10     -0.29     -0.17     -0.11
#> beta[male]                                  0.00    0.00 0.10     -0.21     -0.07      0.00
#> beta[age:.trtclassActive]                  -0.01    0.00 0.01     -0.03     -0.02     -0.01
#> beta[iss_stage3:.trtclassActive]            0.24    0.00 0.18     -0.11      0.11      0.24
#> beta[response_cr_vgpr:.trtclassActive]      0.15    0.00 0.14     -0.12      0.06      0.15
#> beta[male:.trtclassActive]                  0.15    0.00 0.15     -0.14      0.05      0.15
#> d[Len]                                     -0.61    0.00 0.07     -0.75     -0.66     -0.61
#> d[Thal]                                    -0.27    0.00 0.13     -0.53     -0.35     -0.27
#> lp__                                   -12473.08    0.16 5.68 -12485.07 -12476.69 -12472.77
#> scoef[Attal2012: Pbo, 1]                    0.03    0.00 0.02      0.01      0.02      0.03
#> scoef[Attal2012: Pbo, 2]                    0.17    0.00 0.07      0.05      0.13      0.17
#> scoef[Attal2012: Pbo, 3]                    0.46    0.00 0.11      0.21      0.39      0.47
#> scoef[Attal2012: Pbo, 4]                    0.15    0.00 0.10      0.01      0.06      0.13
#> scoef[Attal2012: Pbo, 5]                    0.19    0.00 0.06      0.08      0.15      0.19
#> scoef[Attal2012: Len, 1]                    0.03    0.00 0.02      0.00      0.01      0.03
#> scoef[Attal2012: Len, 2]                    0.18    0.00 0.07      0.04      0.13      0.18
#> scoef[Attal2012: Len, 3]                    0.26    0.00 0.13      0.03      0.16      0.25
#> scoef[Attal2012: Len, 4]                    0.31    0.00 0.12      0.07      0.22      0.31
#> scoef[Attal2012: Len, 5]                    0.23    0.00 0.06      0.11      0.18      0.22
#> scoef[McCarthy2012: Pbo, 1]                 0.01    0.00 0.01      0.00      0.00      0.01
#> scoef[McCarthy2012: Pbo, 2]                 0.30    0.00 0.06      0.18      0.26      0.30
#> scoef[McCarthy2012: Pbo, 3]                 0.20    0.00 0.12      0.02      0.11      0.19
#> scoef[McCarthy2012: Pbo, 4]                 0.30    0.00 0.14      0.04      0.20      0.31
#> scoef[McCarthy2012: Pbo, 5]                 0.19    0.00 0.11      0.01      0.10      0.18
#> scoef[McCarthy2012: Len, 1]                 0.01    0.00 0.01      0.00      0.00      0.01
#> scoef[McCarthy2012: Len, 2]                 0.26    0.00 0.06      0.13      0.22      0.26
#> scoef[McCarthy2012: Len, 3]                 0.20    0.00 0.12      0.01      0.11      0.19
#> scoef[McCarthy2012: Len, 4]                 0.30    0.00 0.13      0.04      0.20      0.30
#> scoef[McCarthy2012: Len, 5]                 0.23    0.00 0.08      0.08      0.18      0.23
#> scoef[Palumbo2014: Pbo, 1]                  0.02    0.00 0.02      0.00      0.01      0.02
#> scoef[Palumbo2014: Pbo, 2]                  0.47    0.00 0.09      0.29      0.41      0.47
#> scoef[Palumbo2014: Pbo, 3]                  0.13    0.00 0.09      0.01      0.05      0.11
#> scoef[Palumbo2014: Pbo, 4]                  0.15    0.00 0.10      0.01      0.07      0.13
#> scoef[Palumbo2014: Pbo, 5]                  0.23    0.00 0.10      0.06      0.17      0.23
#> scoef[Palumbo2014: Len, 1]                  0.02    0.00 0.01      0.00      0.00      0.01
#> scoef[Palumbo2014: Len, 2]                  0.23    0.00 0.09      0.07      0.16      0.22
#> scoef[Palumbo2014: Len, 3]                  0.38    0.00 0.16      0.07      0.27      0.38
#> scoef[Palumbo2014: Len, 4]                  0.20    0.00 0.14      0.01      0.08      0.17
#> scoef[Palumbo2014: Len, 5]                  0.18    0.00 0.10      0.02      0.11      0.18
#> scoef[Jackson2019: Pbo, 1]                  0.06    0.00 0.01      0.04      0.05      0.06
#> scoef[Jackson2019: Pbo, 2]                  0.30    0.00 0.05      0.21      0.27      0.30
#> scoef[Jackson2019: Pbo, 3]                  0.26    0.00 0.08      0.10      0.21      0.27
#> scoef[Jackson2019: Pbo, 4]                  0.13    0.00 0.09      0.01      0.06      0.12
#> scoef[Jackson2019: Pbo, 5]                  0.25    0.00 0.06      0.13      0.22      0.26
#> scoef[Jackson2019: Len, 1]                  0.02    0.00 0.01      0.01      0.02      0.02
#> scoef[Jackson2019: Len, 2]                  0.36    0.00 0.04      0.27      0.33      0.36
#> scoef[Jackson2019: Len, 3]                  0.17    0.00 0.08      0.03      0.12      0.17
#> scoef[Jackson2019: Len, 4]                  0.28    0.00 0.08      0.13      0.23      0.28
#> scoef[Jackson2019: Len, 5]                  0.16    0.00 0.04      0.09      0.14      0.16
#> scoef[Morgan2012: Pbo, 1]                   0.03    0.00 0.01      0.01      0.02      0.03
#> scoef[Morgan2012: Pbo, 2]                   0.40    0.00 0.06      0.29      0.36      0.40
#> scoef[Morgan2012: Pbo, 3]                   0.12    0.00 0.08      0.01      0.05      0.10
#> scoef[Morgan2012: Pbo, 4]                   0.30    0.00 0.11      0.08      0.23      0.31
#> scoef[Morgan2012: Pbo, 5]                   0.15    0.00 0.08      0.02      0.09      0.14
#> scoef[Morgan2012: Thal, 1]                  0.02    0.00 0.01      0.00      0.01      0.02
#> scoef[Morgan2012: Thal, 2]                  0.48    0.00 0.06      0.36      0.44      0.48
#> scoef[Morgan2012: Thal, 3]                  0.15    0.00 0.10      0.01      0.08      0.14
#> scoef[Morgan2012: Thal, 4]                  0.28    0.00 0.10      0.06      0.22      0.29
#> scoef[Morgan2012: Thal, 5]                  0.07    0.00 0.05      0.00      0.03      0.06
#>                                              75%     97.5% n_eff Rhat
#> beta[age]                                   0.08      0.09  2216 1.00
#> beta[iss_stage3]                            0.42      0.58  6138 1.00
#> beta[response_cr_vgpr]                     -0.04      0.08  5661 1.00
#> beta[male]                                  0.06      0.19  6871 1.00
#> beta[age:.trtclassActive]                  -0.01      0.01  2534 1.00
#> beta[iss_stage3:.trtclassActive]            0.36      0.59  5870 1.00
#> beta[response_cr_vgpr:.trtclassActive]      0.25      0.43  5511 1.00
#> beta[male:.trtclassActive]                  0.25      0.45  5021 1.00
#> d[Len]                                     -0.57     -0.48  3125 1.00
#> d[Thal]                                    -0.18     -0.02  3754 1.00
#> lp__                                   -12469.06 -12462.95  1240 1.00
#> scoef[Attal2012: Pbo, 1]                    0.04      0.07  3057 1.00
#> scoef[Attal2012: Pbo, 2]                    0.22      0.31  2162 1.00
#> scoef[Attal2012: Pbo, 3]                    0.54      0.65  2063 1.00
#> scoef[Attal2012: Pbo, 4]                    0.21      0.37  2671 1.00
#> scoef[Attal2012: Pbo, 5]                    0.23      0.31  4213 1.00
#> scoef[Attal2012: Len, 1]                    0.04      0.08  3132 1.00
#> scoef[Attal2012: Len, 2]                    0.23      0.32  2367 1.00
#> scoef[Attal2012: Len, 3]                    0.35      0.52  2260 1.00
#> scoef[Attal2012: Len, 4]                    0.40      0.54  2831 1.00
#> scoef[Attal2012: Len, 5]                    0.27      0.36  3702 1.00
#> scoef[McCarthy2012: Pbo, 1]                 0.01      0.03  5235 1.00
#> scoef[McCarthy2012: Pbo, 2]                 0.34      0.42  3670 1.00
#> scoef[McCarthy2012: Pbo, 3]                 0.28      0.45  3512 1.00
#> scoef[McCarthy2012: Pbo, 4]                 0.41      0.56  3277 1.00
#> scoef[McCarthy2012: Pbo, 5]                 0.27      0.41  3494 1.00
#> scoef[McCarthy2012: Len, 1]                 0.02      0.04  4684 1.00
#> scoef[McCarthy2012: Len, 2]                 0.30      0.38  3049 1.00
#> scoef[McCarthy2012: Len, 3]                 0.28      0.45  2374 1.00
#> scoef[McCarthy2012: Len, 4]                 0.40      0.55  3123 1.00
#> scoef[McCarthy2012: Len, 5]                 0.29      0.39  4068 1.00
#> scoef[Palumbo2014: Pbo, 1]                  0.03      0.07  4681 1.00
#> scoef[Palumbo2014: Pbo, 2]                  0.53      0.64  3988 1.00
#> scoef[Palumbo2014: Pbo, 3]                  0.18      0.34  4258 1.00
#> scoef[Palumbo2014: Pbo, 4]                  0.21      0.38  5324 1.00
#> scoef[Palumbo2014: Pbo, 5]                  0.30      0.42  5781 1.00
#> scoef[Palumbo2014: Len, 1]                  0.02      0.05  5708 1.00
#> scoef[Palumbo2014: Len, 2]                  0.29      0.41  3657 1.00
#> scoef[Palumbo2014: Len, 3]                  0.49      0.67  3305 1.00
#> scoef[Palumbo2014: Len, 4]                  0.29      0.52  3535 1.00
#> scoef[Palumbo2014: Len, 5]                  0.25      0.39  5333 1.00
#> scoef[Jackson2019: Pbo, 1]                  0.06      0.08  2324 1.01
#> scoef[Jackson2019: Pbo, 2]                  0.33      0.40  2500 1.00
#> scoef[Jackson2019: Pbo, 3]                  0.32      0.41  2483 1.00
#> scoef[Jackson2019: Pbo, 4]                  0.18      0.33  2635 1.00
#> scoef[Jackson2019: Pbo, 5]                  0.29      0.37  3039 1.00
#> scoef[Jackson2019: Len, 1]                  0.03      0.04  3353 1.00
#> scoef[Jackson2019: Len, 2]                  0.39      0.44  1886 1.00
#> scoef[Jackson2019: Len, 3]                  0.23      0.33  1757 1.00
#> scoef[Jackson2019: Len, 4]                  0.34      0.43  2340 1.00
#> scoef[Jackson2019: Len, 5]                  0.19      0.24  3382 1.00
#> scoef[Morgan2012: Pbo, 1]                   0.04      0.06  3363 1.00
#> scoef[Morgan2012: Pbo, 2]                   0.44      0.52  2588 1.00
#> scoef[Morgan2012: Pbo, 3]                   0.17      0.31  2850 1.00
#> scoef[Morgan2012: Pbo, 4]                   0.37      0.49  3817 1.00
#> scoef[Morgan2012: Pbo, 5]                   0.20      0.31  3731 1.00
#> scoef[Morgan2012: Thal, 1]                  0.02      0.04  4551 1.00
#> scoef[Morgan2012: Thal, 2]                  0.52      0.60  3293 1.00
#> scoef[Morgan2012: Thal, 3]                  0.22      0.36  2756 1.00
#> scoef[Morgan2012: Thal, 4]                  0.35      0.45  3444 1.00
#> scoef[Morgan2012: Thal, 5]                  0.10      0.19  3985 1.00
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 21:49:33 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).
```

We then compare model fit between models with and without PH using the LOOIC.

```r
(ndmm_fit_nph_loo <- loo(ndmm_fit_nph))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12389.4 116.2
#> p_loo        44.5   1.1
#> looic     24778.8 232.5
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

# Compare to PH model
loo_compare(ndmm_fit_1kt_loo, ndmm_fit_nph_loo)
#>        elpd_diff se_diff
#> model1  0.0       0.0   
#> model2 -3.9       4.4   
```
The overall fit for the proportional hazards model is better (but not substantially).

Again, we should check that no single study has a better fit with the non-PH model.

```r
cbind(
  PH = by(ndmm_fit_1kt_loo$pointwise[, "looic"], studies_all, sum),
  `non-PH` = by(ndmm_fit_nph_loo$pointwise[, "looic"], studies_all, sum)
)
#>                     PH    non-PH
#> Attal2012     3342.043  3344.800
#> Jackson2019  12394.107 12391.884
#> McCarthy2012  2723.239  2728.845
#> Morgan2012    4981.445  4984.381
#> Palumbo2014   1330.072  1328.877
```
The LOOIC is slightly lower for the non-PH model in the Jackson2019 and Palumbo2014 studies, but not substantially so.
For the other studies the LOOIC is lower for the PH model.
Overall, there is little evidence to suggest that the proportional hazards assumption is invalid here.

## Comparison to unadjusted NMA
For comparison, we also fit NMA models without any covariate adjustment, both with and without the proportional hazards assumption.

```r
ndmm_fit_nma <- nma(ndmm_net,
                    likelihood = "mspline",
                    n_knots = 1,
                    prior_intercept = normal(0, 100),
                    prior_trt = normal(0, 100),
                    prior_aux = dirichlet(1))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_nma
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                             mean se_mean   sd      2.5%       25%       50%       75%     97.5%
#> d[Len]                     -0.52    0.00 0.04     -0.61     -0.55     -0.52     -0.49     -0.43
#> d[Thal]                    -0.10    0.00 0.09     -0.27     -0.16     -0.10     -0.04      0.06
#> lp__                   -12503.23    0.11 4.05 -12511.77 -12505.82 -12502.95 -12500.28 -12496.36
#> scoef[Attal2012, 1]         0.03    0.00 0.01      0.01      0.02      0.03      0.04      0.06
#> scoef[Attal2012, 2]         0.20    0.00 0.06      0.09      0.16      0.20      0.24      0.32
#> scoef[Attal2012, 3]         0.39    0.00 0.10      0.19      0.33      0.40      0.46      0.58
#> scoef[Attal2012, 4]         0.18    0.00 0.09      0.03      0.11      0.17      0.23      0.36
#> scoef[Attal2012, 5]         0.20    0.00 0.04      0.12      0.17      0.20      0.23      0.28
#> scoef[McCarthy2012, 1]      0.01    0.00 0.01      0.00      0.00      0.00      0.01      0.02
#> scoef[McCarthy2012, 2]      0.32    0.00 0.05      0.23      0.29      0.32      0.35      0.41
#> scoef[McCarthy2012, 3]      0.16    0.00 0.09      0.02      0.09      0.16      0.23      0.35
#> scoef[McCarthy2012, 4]      0.30    0.00 0.11      0.09      0.22      0.30      0.37      0.50
#> scoef[McCarthy2012, 5]      0.21    0.00 0.07      0.08      0.16      0.21      0.26      0.35
#> scoef[Palumbo2014, 1]       0.02    0.00 0.02      0.00      0.01      0.01      0.03      0.06
#> scoef[Palumbo2014, 2]       0.46    0.00 0.07      0.31      0.41      0.46      0.51      0.60
#> scoef[Palumbo2014, 3]       0.18    0.00 0.10      0.01      0.10      0.17      0.25      0.39
#> scoef[Palumbo2014, 4]       0.17    0.00 0.10      0.01      0.08      0.16      0.24      0.39
#> scoef[Palumbo2014, 5]       0.18    0.00 0.07      0.04      0.13      0.18      0.23      0.33
#> scoef[Jackson2019, 1]       0.06    0.00 0.01      0.04      0.05      0.06      0.06      0.07
#> scoef[Jackson2019, 2]       0.39    0.00 0.03      0.33      0.37      0.39      0.42      0.46
#> scoef[Jackson2019, 3]       0.19    0.00 0.06      0.06      0.15      0.19      0.23      0.31
#> scoef[Jackson2019, 4]       0.20    0.00 0.06      0.08      0.16      0.20      0.24      0.32
#> scoef[Jackson2019, 5]       0.16    0.00 0.03      0.10      0.14      0.16      0.18      0.22
#> scoef[Morgan2012, 1]        0.03    0.00 0.01      0.01      0.03      0.03      0.04      0.06
#> scoef[Morgan2012, 2]        0.54    0.00 0.04      0.46      0.51      0.54      0.57      0.62
#> scoef[Morgan2012, 3]        0.07    0.00 0.06      0.00      0.03      0.06      0.11      0.21
#> scoef[Morgan2012, 4]        0.29    0.00 0.06      0.15      0.25      0.29      0.33      0.40
#> scoef[Morgan2012, 5]        0.06    0.00 0.04      0.01      0.03      0.06      0.09      0.15
#>                        n_eff Rhat
#> d[Len]                  2978    1
#> d[Thal]                 4013    1
#> lp__                    1395    1
#> scoef[Attal2012, 1]     3007    1
#> scoef[Attal2012, 2]     2364    1
#> scoef[Attal2012, 3]     2346    1
#> scoef[Attal2012, 4]     2882    1
#> scoef[Attal2012, 5]     3828    1
#> scoef[McCarthy2012, 1]  6595    1
#> scoef[McCarthy2012, 2]  3449    1
#> scoef[McCarthy2012, 3]  3024    1
#> scoef[McCarthy2012, 4]  3374    1
#> scoef[McCarthy2012, 5]  3625    1
#> scoef[Palumbo2014, 1]   5315    1
#> scoef[Palumbo2014, 2]   4138    1
#> scoef[Palumbo2014, 3]   3389    1
#> scoef[Palumbo2014, 4]   4881    1
#> scoef[Palumbo2014, 5]   5368    1
#> scoef[Jackson2019, 1]   4388    1
#> scoef[Jackson2019, 2]   2848    1
#> scoef[Jackson2019, 3]   2470    1
#> scoef[Jackson2019, 4]   2915    1
#> scoef[Jackson2019, 5]   3695    1
#> scoef[Morgan2012, 1]    5208    1
#> scoef[Morgan2012, 2]    3911    1
#> scoef[Morgan2012, 3]    3425    1
#> scoef[Morgan2012, 4]    4896    1
#> scoef[Morgan2012, 5]    5102    1
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 21:55:07 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).

ndmm_fit_nma_nph <- nma(ndmm_net,
                        likelihood = "mspline",
                        n_knots = 1,
                        prior_intercept = normal(0, 100),
                        prior_trt = normal(0, 100),
                        prior_aux = dirichlet(1),
                        aux_by = c(.study, .trt))
#> Note: Setting "Pbo" as the network reference treatment.

ndmm_fit_nma_nph
#> A fixed effects ML-NMR with a mspline likelihood (log link).
#> Inference for Stan model: survival_mspline.
#> 4 chains, each with iter=2000; warmup=1000; thin=1; 
#> post-warmup draws per chain=1000, total post-warmup draws=4000.
#> 
#>                                  mean se_mean   sd      2.5%       25%       50%       75%
#> d[Len]                          -0.46    0.00 0.05     -0.56     -0.50     -0.46     -0.43
#> d[Thal]                         -0.13    0.00 0.10     -0.33     -0.20     -0.13     -0.06
#> lp__                        -12548.70    0.15 5.42 -12560.09 -12552.11 -12548.29 -12544.91
#> scoef[Attal2012: Pbo, 1]         0.04    0.00 0.02      0.01      0.02      0.03      0.05
#> scoef[Attal2012: Pbo, 2]         0.21    0.00 0.07      0.07      0.16      0.21      0.26
#> scoef[Attal2012: Pbo, 3]         0.45    0.00 0.11      0.21      0.38      0.46      0.53
#> scoef[Attal2012: Pbo, 4]         0.13    0.00 0.09      0.01      0.06      0.11      0.18
#> scoef[Attal2012: Pbo, 5]         0.17    0.00 0.05      0.07      0.13      0.17      0.21
#> scoef[Attal2012: Len, 1]         0.03    0.00 0.02      0.00      0.02      0.03      0.05
#> scoef[Attal2012: Len, 2]         0.19    0.00 0.07      0.04      0.14      0.19      0.24
#> scoef[Attal2012: Len, 3]         0.28    0.00 0.13      0.05      0.19      0.28      0.37
#> scoef[Attal2012: Len, 4]         0.28    0.00 0.12      0.05      0.20      0.28      0.37
#> scoef[Attal2012: Len, 5]         0.21    0.00 0.06      0.10      0.17      0.21      0.25
#> scoef[McCarthy2012: Pbo, 1]      0.01    0.00 0.01      0.00      0.00      0.01      0.02
#> scoef[McCarthy2012: Pbo, 2]      0.33    0.00 0.07      0.20      0.29      0.33      0.38
#> scoef[McCarthy2012: Pbo, 3]      0.20    0.00 0.12      0.02      0.11      0.19      0.28
#> scoef[McCarthy2012: Pbo, 4]      0.28    0.00 0.14      0.03      0.18      0.28      0.38
#> scoef[McCarthy2012: Pbo, 5]      0.17    0.00 0.11      0.01      0.09      0.16      0.25
#> scoef[McCarthy2012: Len, 1]      0.01    0.00 0.01      0.00      0.00      0.01      0.02
#> scoef[McCarthy2012: Len, 2]      0.29    0.00 0.07      0.16      0.24      0.29      0.34
#> scoef[McCarthy2012: Len, 3]      0.19    0.00 0.12      0.01      0.10      0.18      0.28
#> scoef[McCarthy2012: Len, 4]      0.28    0.00 0.13      0.04      0.19      0.28      0.38
#> scoef[McCarthy2012: Len, 5]      0.22    0.00 0.08      0.08      0.17      0.22      0.27
#> scoef[Palumbo2014: Pbo, 1]       0.04    0.00 0.03      0.00      0.02      0.03      0.06
#> scoef[Palumbo2014: Pbo, 2]       0.54    0.00 0.09      0.34      0.48      0.54      0.60
#> scoef[Palumbo2014: Pbo, 3]       0.11    0.00 0.09      0.00      0.04      0.09      0.16
#> scoef[Palumbo2014: Pbo, 4]       0.13    0.00 0.09      0.01      0.06      0.12      0.19
#> scoef[Palumbo2014: Pbo, 5]       0.18    0.00 0.08      0.04      0.12      0.18      0.24
#> scoef[Palumbo2014: Len, 1]       0.02    0.00 0.02      0.00      0.01      0.01      0.03
#> scoef[Palumbo2014: Len, 2]       0.25    0.00 0.10      0.07      0.18      0.25      0.32
#> scoef[Palumbo2014: Len, 3]       0.37    0.00 0.16      0.06      0.26      0.37      0.48
#> scoef[Palumbo2014: Len, 4]       0.18    0.00 0.13      0.01      0.07      0.15      0.27
#> scoef[Palumbo2014: Len, 5]       0.18    0.00 0.10      0.02      0.11      0.18      0.25
#> scoef[Jackson2019: Pbo, 1]       0.08    0.00 0.01      0.06      0.07      0.08      0.09
#> scoef[Jackson2019: Pbo, 2]       0.38    0.00 0.05      0.29      0.35      0.38      0.42
#> scoef[Jackson2019: Pbo, 3]       0.22    0.00 0.07      0.07      0.17      0.22      0.27
#> scoef[Jackson2019: Pbo, 4]       0.11    0.00 0.07      0.01      0.05      0.10      0.16
#> scoef[Jackson2019: Pbo, 5]       0.20    0.00 0.05      0.11      0.17      0.20      0.24
#> scoef[Jackson2019: Len, 1]       0.03    0.00 0.01      0.01      0.02      0.03      0.03
#> scoef[Jackson2019: Len, 2]       0.42    0.00 0.04      0.33      0.39      0.42      0.45
#> scoef[Jackson2019: Len, 3]       0.16    0.00 0.08      0.02      0.10      0.15      0.21
#> scoef[Jackson2019: Len, 4]       0.26    0.00 0.07      0.11      0.22      0.27      0.32
#> scoef[Jackson2019: Len, 5]       0.14    0.00 0.03      0.07      0.11      0.13      0.16
#> scoef[Morgan2012: Pbo, 1]        0.05    0.00 0.02      0.02      0.04      0.05      0.06
#> scoef[Morgan2012: Pbo, 2]        0.48    0.00 0.06      0.36      0.44      0.48      0.52
#> scoef[Morgan2012: Pbo, 3]        0.10    0.00 0.08      0.00      0.04      0.09      0.15
#> scoef[Morgan2012: Pbo, 4]        0.25    0.00 0.09      0.05      0.19      0.25      0.31
#> scoef[Morgan2012: Pbo, 5]        0.12    0.00 0.06      0.02      0.07      0.11      0.16
#> scoef[Morgan2012: Thal, 1]       0.02    0.00 0.01      0.00      0.01      0.02      0.03
#> scoef[Morgan2012: Thal, 2]       0.56    0.00 0.06      0.44      0.52      0.56      0.60
#> scoef[Morgan2012: Thal, 3]       0.12    0.00 0.08      0.01      0.06      0.11      0.17
#> scoef[Morgan2012: Thal, 4]       0.24    0.00 0.08      0.06      0.19      0.25      0.30
#> scoef[Morgan2012: Thal, 5]       0.06    0.00 0.04      0.00      0.03      0.05      0.09
#>                                 97.5% n_eff Rhat
#> d[Len]                          -0.36  3061    1
#> d[Thal]                          0.07  3427    1
#> lp__                        -12539.10  1292    1
#> scoef[Attal2012: Pbo, 1]         0.08  3716    1
#> scoef[Attal2012: Pbo, 2]         0.36  2527    1
#> scoef[Attal2012: Pbo, 3]         0.65  2431    1
#> scoef[Attal2012: Pbo, 4]         0.34  2795    1
#> scoef[Attal2012: Pbo, 5]         0.28  3952    1
#> scoef[Attal2012: Len, 1]         0.09  3219    1
#> scoef[Attal2012: Len, 2]         0.33  2734    1
#> scoef[Attal2012: Len, 3]         0.54  2558    1
#> scoef[Attal2012: Len, 4]         0.51  2982    1
#> scoef[Attal2012: Len, 5]         0.33  4146    1
#> scoef[McCarthy2012: Pbo, 1]      0.04  5654    1
#> scoef[McCarthy2012: Pbo, 2]      0.47  3260    1
#> scoef[McCarthy2012: Pbo, 3]      0.45  3526    1
#> scoef[McCarthy2012: Pbo, 4]      0.53  3302    1
#> scoef[McCarthy2012: Pbo, 5]      0.40  3313    1
#> scoef[McCarthy2012: Len, 1]      0.05  5359    1
#> scoef[McCarthy2012: Len, 2]      0.42  3494    1
#> scoef[McCarthy2012: Len, 3]      0.44  2615    1
#> scoef[McCarthy2012: Len, 4]      0.52  3389    1
#> scoef[McCarthy2012: Len, 5]      0.37  4228    1
#> scoef[Palumbo2014: Pbo, 1]       0.11  4909    1
#> scoef[Palumbo2014: Pbo, 2]       0.70  4223    1
#> scoef[Palumbo2014: Pbo, 3]       0.31  3717    1
#> scoef[Palumbo2014: Pbo, 4]       0.34  4973    1
#> scoef[Palumbo2014: Pbo, 5]       0.34  6107    1
#> scoef[Palumbo2014: Len, 1]       0.06  5491    1
#> scoef[Palumbo2014: Len, 2]       0.45  4035    1
#> scoef[Palumbo2014: Len, 3]       0.66  3294    1
#> scoef[Palumbo2014: Len, 4]       0.48  3538    1
#> scoef[Palumbo2014: Len, 5]       0.38  5038    1
#> scoef[Jackson2019: Pbo, 1]       0.11  4284    1
#> scoef[Jackson2019: Pbo, 2]       0.48  2761    1
#> scoef[Jackson2019: Pbo, 3]       0.36  2322    1
#> scoef[Jackson2019: Pbo, 4]       0.27  2512    1
#> scoef[Jackson2019: Pbo, 5]       0.30  3455    1
#> scoef[Jackson2019: Len, 1]       0.05  4152    1
#> scoef[Jackson2019: Len, 2]       0.50  3220    1
#> scoef[Jackson2019: Len, 3]       0.32  2662    1
#> scoef[Jackson2019: Len, 4]       0.39  2987    1
#> scoef[Jackson2019: Len, 5]       0.21  4141    1
#> scoef[Morgan2012: Pbo, 1]        0.09  4143    1
#> scoef[Morgan2012: Pbo, 2]        0.59  3575    1
#> scoef[Morgan2012: Pbo, 3]        0.28  3103    1
#> scoef[Morgan2012: Pbo, 4]        0.41  4253    1
#> scoef[Morgan2012: Pbo, 5]        0.25  4940    1
#> scoef[Morgan2012: Thal, 1]       0.05  5500    1
#> scoef[Morgan2012: Thal, 2]       0.67  4790    1
#> scoef[Morgan2012: Thal, 3]       0.30  3678    1
#> scoef[Morgan2012: Thal, 4]       0.39  4719    1
#> scoef[Morgan2012: Thal, 5]       0.16  4992    1
#> 
#> Samples were drawn using NUTS(diag_e) at Fri Aug 25 22:00:38 2023.
#> For each parameter, n_eff is a crude measure of effective sample size,
#> and Rhat is the potential scale reduction factor on split chains (at 
#> convergence, Rhat=1).
```

Again, we compare the model fit using the LOOIC, both overall and within each study.

```r
# Compare overall model fit
(ndmm_fit_nma_loo <- loo(ndmm_fit_nma))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12461.3 115.4
#> p_loo        22.6   0.6
#> looic     24922.7 230.8
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

(ndmm_fit_nma_nph_loo <- loo(ndmm_fit_nma_nph))
#> 
#> Computed from 4000 by 4144 log-likelihood matrix
#> 
#>          Estimate    SE
#> elpd_loo -12460.3 115.4
#> p_loo        35.1   1.0
#> looic     24920.5 230.9
#> ------
#> Monte Carlo SE of elpd_loo is 0.1.
#> 
#> All Pareto k estimates are good (k < 0.5).
#> See help('pareto-k-diagnostic') for details.

loo_compare(ndmm_fit_nma_loo, ndmm_fit_nma_nph_loo)
#>        elpd_diff se_diff
#> model2  0.0       0.0   
#> model1 -1.1       5.3   

# Compare model fit by study
cbind(
  PH = by(ndmm_fit_nma_loo$pointwise[, "looic"], studies_all, sum),
  `non-PH` = by(ndmm_fit_nma_nph_loo$pointwise[, "looic"], studies_all, sum)
)
#>                     PH    non-PH
#> Attal2012     3406.395  3408.744
#> Jackson2019  12401.491 12391.276
#> McCarthy2012  2766.946  2771.886
#> Morgan2012    4981.328  4984.390
#> Palumbo2014   1366.513  1364.247
```
Whilst there is little difference in overall model fit, the non-PH model is preferred in the Jackson2019 study with a substantially lower LOOIC.
Including the covariates in the ML-NMR model is sufficient to remove this PH violation, even though the covariates are fixed and not time-varying, and the ML-NMR model is a much better fit overall.

# Producing population-average estimates
We now produce population-average estimates for several different quantities of interest.
The usual array of posterior summary functions is available, including `relative_effects()`, `predict()`, `posterior_ranks()` and `posterior_rank_probs()`.
The `predict()` function in particular has numerous options when working with survival models, selected using the `type` argument:

* `"survival"` for survival probabilities
* `"hazard"` for hazards
* `"cumhaz"` for cumulative hazards
* `"rmst"` for restricted mean survival times
* `"mean"` for mean survival times (equivalent to `type = "rmst"` with `time = Inf`)
* `"quantile"` for quantiles of the survival time distribution
* `"median"` for median survival times (equivalent to `type = "quantile"` with `quantiles = 0.5`)
* `"link"` for the linear predictor

When producing population-average predictions (which is the default with `level = "aggregate"`), each of these quantities corresponds to the population-average marginal survival function; see `?predict.stan_nma` for more details.

## Population-average survival probabilities
To produce population-average survival curves we use the `predict()` function with `type = "survival"`.
These are marginal or standardised survival curves.
We also overlay the "raw" Kaplan-Meier curves using the `geom_km()` helper function.
```r
plot(predict(ndmm_fit_1kt, type = "survival")) + 
  geom_km(ndmm_net) +
  theme(legend.position = "top", legend.box.spacing = unit(0, "lines"))
```

<img src="figure/ndmm-survival-1.png" style="display: block; margin: auto;" />

## Population-average median survival times
The `predict()` function can produce a range of other absolute effect summaries, for example population-average median survival times:

```r
(medsurv <- predict(ndmm_fit_1kt, type = "median"))
#> Warning: Evaluating M-spline at times beyond the boundary knots.
#> Evaluating M-spline at times beyond the boundary knots.
#> Evaluating M-spline at times beyond the boundary knots.
#> -------------------------------------------------------------- Study: Attal2012 ---- 
#> 
#>                        mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> pred[Attal2012: Pbo]  28.70 1.58 25.71 27.61 28.66 29.78 31.89     4745     3841 1.00
#> pred[Attal2012: Len]  46.73 2.44 42.11 45.04 46.67 48.22 51.76     9315     3365 1.00
#> pred[Attal2012: Thal] 32.09 3.64 25.61 29.58 31.82 34.32 40.13     3745     3106 1.01
#> 
#> ----------------------------------------------------------- Study: McCarthy2012 ---- 
#> 
#>                           mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> pred[McCarthy2012: Pbo]  33.38 2.24 29.20 31.82 33.31 34.82 37.97     3962     3084 1.00
#> pred[McCarthy2012: Len]  56.00 3.14 50.08 53.83 55.87 58.05 62.39     5489     3362 1.00
#> pred[McCarthy2012: Thal] 38.53 4.49 30.22 35.47 38.41 41.43 47.67     3274     3168 1.01
#> 
#> ------------------------------------------------------------ Study: Palumbo2014 ---- 
#> 
#>                          mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> pred[Palumbo2014: Pbo]  21.13 2.30 17.08 19.48 21.01 22.62 26.03     5413     3337    1
#> pred[Palumbo2014: Len]  45.00 5.10 35.93 41.48 44.80 48.07 54.91     6004     3412    1
#> pred[Palumbo2014: Thal] 26.60 4.76 18.58 23.22 26.15 29.44 37.10     4761     3278    1
#> 
#> ------------------------------------------------------------ Study: Jackson2019 ---- 
#> 
#>                          mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> pred[Jackson2019: Pbo]  24.15 1.33 21.67 23.23 24.11 25.04 26.87     2566     3327 1.01
#> pred[Jackson2019: Len]  50.99 2.52 46.06 49.28 50.96 52.67 55.99       88     3022 1.03
#> pred[Jackson2019: Thal] 31.10 3.87 24.30 28.36 30.82 33.41 39.59     6238     3128 1.00
#> 
#> ------------------------------------------------------------- Study: Morgan2012 ---- 
#> 
#>                         mean    sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> pred[Morgan2012: Pbo]  20.73  1.91 17.26 19.39 20.62 21.96 24.76     2535     3344 1.01
#> pred[Morgan2012: Len]  49.95 70.67 37.84 44.01 47.84 52.12 64.21      770     3185 1.01
#> pred[Morgan2012: Thal] 27.34  2.43 22.93 25.65 27.22 28.89 32.42     5881     3470 1.00

plot(medsurv)
```

<img src="figure/ndmm-median-survival-1.png" style="display: block; margin: auto;" />

## Population-average conditional log hazard ratios
Relative effects are produced using the `relative_effects()` function.
With a ML-NMR model (or an IPD meta-regression), these are population-average conditional log hazard ratios (or log survival time ratios for AFT models).

```r
(loghr <- relative_effects(ndmm_fit_1kt, all_contrasts = TRUE))
#> -------------------------------------------------------------- Study: Attal2012 ---- 
#> 
#> Covariate values:
#>    age iss_stage3 response_cr_vgpr male
#>  54.29        0.2             0.54 0.57
#> 
#>                             mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> d[Attal2012: Len vs. Pbo]  -0.59 0.07 -0.74 -0.64 -0.59 -0.54 -0.45     6206     3113 1.00
#> d[Attal2012: Thal vs. Pbo] -0.12 0.13 -0.39 -0.21 -0.12 -0.03  0.14     4379     3188 1.01
#> d[Attal2012: Thal vs. Len]  0.47 0.12  0.23  0.39  0.47  0.55  0.70     1026     3072 1.01
#> 
#> ----------------------------------------------------------- Study: McCarthy2012 ---- 
#> 
#> Covariate values:
#>    age iss_stage3 response_cr_vgpr male
#>  57.66       0.23             0.67 0.54
#> 
#>                                mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> d[McCarthy2012: Len vs. Pbo]  -0.62 0.06 -0.74 -0.66 -0.62 -0.58 -0.51     5733     3240 1.00
#> d[McCarthy2012: Thal vs. Pbo] -0.15 0.12 -0.39 -0.23 -0.15 -0.07  0.08     4199     2973 1.01
#> d[McCarthy2012: Thal vs. Len]  0.47 0.12  0.23  0.39  0.47  0.55  0.70     1026     3072 1.01
#> 
#> ------------------------------------------------------------ Study: Palumbo2014 ---- 
#> 
#> Covariate values:
#>    age iss_stage3 response_cr_vgpr male
#>  54.17       0.11              0.4 0.55
#> 
#>                               mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> d[Palumbo2014: Len vs. Pbo]  -0.64 0.08 -0.80 -0.69 -0.64 -0.58 -0.48     6475     3111 1.00
#> d[Palumbo2014: Thal vs. Pbo] -0.17 0.14 -0.45 -0.26 -0.17 -0.08  0.11     4947     3204 1.01
#> d[Palumbo2014: Thal vs. Len]  0.47 0.12  0.23  0.39  0.47  0.55  0.70     1026     3072 1.01
#> 
#> ------------------------------------------------------------ Study: Jackson2019 ---- 
#> 
#> Covariate values:
#>    age iss_stage3 response_cr_vgpr male
#>  64.63       0.21             0.84 0.62
#> 
#>                               mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> d[Jackson2019: Len vs. Pbo]  -0.70 0.06 -0.82 -0.74 -0.70 -0.65 -0.57     4415     3352 1.01
#> d[Jackson2019: Thal vs. Pbo] -0.23 0.11 -0.45 -0.30 -0.23 -0.15 -0.02     5473     2863 1.00
#> d[Jackson2019: Thal vs. Len]  0.47 0.12  0.23  0.39  0.47  0.55  0.70     1026     3072 1.01
#> 
#> ------------------------------------------------------------- Study: Morgan2012 ---- 
#> 
#> Covariate values:
#>    age iss_stage3 response_cr_vgpr male
#>  64.46       0.33             0.73 0.62
#> 
#>                              mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS Rhat
#> d[Morgan2012: Len vs. Pbo]  -0.69 0.06 -0.82 -0.74 -0.70 -0.65 -0.57     4724     3265 1.01
#> d[Morgan2012: Thal vs. Pbo] -0.22 0.10 -0.44 -0.29 -0.22 -0.15 -0.02     5072     2969 1.00
#> d[Morgan2012: Thal vs. Len]  0.47 0.12  0.23  0.39  0.47  0.55  0.70     1026     3072 1.01

plot(loghr)
```

<img src="figure/ndmm-loghr-1.png" style="display: block; margin: auto;" />

# References
