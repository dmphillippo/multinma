---
title: "Example: Certolizumab"
output: rmarkdown::html_vignette
link-citations: yes
bibliography: ../inst/REFERENCES.bib
params:
  run_tests: FALSE
---

```{r, code=readLines("children/knitr_setup.R"), include=FALSE}
```
```{r, include=FALSE}
set.seed(76439)
```

```{r, eval = FALSE}
library(multinma)
options(mc.cores = parallel::detectCores())
```
```{r setup, echo = FALSE}
library(multinma)
nc <- switch(tolower(Sys.getenv("_R_CHECK_LIMIT_CORES_")), 
             "true" =, "warn" = 2, 
             parallel::detectCores())
options(mc.cores = nc)
```

This vignette describes the analysis of data on [@TSD3].
The data are available in this package as `certolizumab`:
```{r}
head(certolizumab)
```

## Setting up the network
We begin by setting up the network.
```{r}
cert_net <- set_agd_arm(certolizumab,
                        study = study, trt = trt, n = n, r = r,
                        trt_class = dplyr::if_else(trt == "Placebo", "Placebo", "Treatment"))
cert_net
```

Plot the network structure.
```{r, eval=FALSE}
plot(cert_net, weight_edges = TRUE, weight_nodes = TRUE)
```
```{r certolizumab_network_plot, echo=FALSE}
plot(cert_net, weight_edges = TRUE, weight_nodes = TRUE) +
  ggplot2::theme(legend.box.margin = ggplot2::unit(c(0, 0, 0, 4), "lines"))
```

## Meta-analysis models
We fit both fixed effect (FE) and random effects (RE) models.

### Fixed effect meta-analysis
```{r}
cert_fit_FE <- nma(cert_net,
                   trt_effects = "fixed",
                   regression = ~.mu:.trt,
                   prior_intercept = normal(scale = sqrt(1000)),
                   prior_trt = normal(scale = 100),
                   prior_reg = normal(scale = 100),
                   iter = 4000,
                   adapt_delta = 0.95)
```

Basic parameter summaries are given by the `print()` method:
```{r}
cert_fit_FE
```

### Random effects meta-analysis
```{r}
cert_fit_RE <- nma(cert_net,
                   trt_effects = "random",
                   regression = ~.mu:.trt,
                   prior_intercept = normal(scale = sqrt(1000)),
                   prior_trt = normal(scale = 100),
                   prior_reg = normal(scale = 100),
                   iter = 4000)
```

Basic parameter summaries are given by the `print()` method:
```{r}
cert_fit_RE
```

### Model comparison
Model fit can be checked using the `dic()` function:
```{r}
(dic_FE <- dic(cert_fit_FE))
(dic_RE <- dic(cert_fit_RE))
```

We can also examine the residual deviance contributions with the corresponding `plot()` method.
```{r}
plot(dic_FE)
```

```{r}
plot(dic_RE)
```


## Further results
```{r}
newdata <- data.frame(.mu = cert_fit_FE$xbar[[".mu"]])
```
For comparison with @TSD3, we can produce relative effects against "Placebo" using the `relative_effects()` function:
```{r certolizumab_releff_FE, fig.height=3}
(cert_releff_FE <- relative_effects(cert_fit_FE, newdata = newdata))
plot(cert_releff_FE, ref_line = 0)
```
```{r certolizumab_releff_RE, fig.height=3}
(cert_releff_RE <- relative_effects(cert_fit_RE, newdata = newdata))
plot(cert_releff_RE, ref_line = 0)
```

We can also produce treatment rankings, rank probabilities, and cumulative rank probabilities.
```{r certolizumab_ranks}
(cert_ranks <- posterior_ranks(cert_fit_RE, newdata = newdata))
plot(cert_ranks)
```
```{r certolizumab_rankprobs}
(cert_rankprobs <- posterior_rank_probs(cert_fit_RE, newdata = newdata))
plot(cert_rankprobs)
```
```{r certolizumab_cumrankprobs}
(cert_cumrankprobs <- posterior_rank_probs(cert_fit_RE, cumulative = TRUE, newdata = newdata))
plot(cert_cumrankprobs)
```

```{r certolizumab_reg_plot}
library(dplyr)
library(ggplot2)

mu_dat <- seq(log(0.02), log(0.5), length.out = 20)

cert_mu_reg <- cert_fit_FE %>%
  relative_effects(newdata = tibble::tibble(.mu = mu_dat), study = .mu) %>%
  as_tibble() %>%
  mutate(
    .trt = .trtb,
    .mu = as.numeric(as.character(.study))
  )

cert_lor <-
  cert_net$agd_arm %>%
  mutate(
    probability = .r / .n,
    log_odds = log(probability / (1 - probability))
  ) %>%
  group_by(.study) %>%
  mutate(
    .mu = log_odds[.trt == "Placebo"],
    log_odds_ratio = log_odds - .mu,
    sample_size = sum(n),
  ) %>%
  ungroup() %>%
  filter(.trt != "Placebo")

cert_lor %>%
  ggplot(aes(x = .mu)) +
  geom_hline(yintercept = 0, colour = "grey60") +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), data = cert_mu_reg,
              fill = "darkred", alpha = 0.3) +
  geom_line(aes(y = mean), data = cert_mu_reg,
            colour = "darkred") +
  geom_point(aes(y = log_odds_ratio, size = sample_size), alpha = 0.6) +
  facet_wrap(vars(.trt)) +
  labs(x = "Placebo log odds", y = "log Odds Ratio", size = "Sample Size") +
  theme_multinma()
```

## References

```{r certolizumab_tests, include=FALSE, eval=params$run_tests}
#--- Test against TSD 3 results ---
library(testthat)
library(dplyr)

tol <- 0.05
tol_dic <- 0.1

# FE Relative effects
tsd_FE <- tribble(
~trt          , ~mean, ~sd , ~lower, ~upper,
"CZP"         , 1.85 , 0.10, 1.67  , 2.06  ,
"Adalimumab"  , 2.13 , 0.11, 1.90  , 2.35  ,
"Etanercept"  , 2.08 , 0.34, 1.47  , 2.80  ,
"Infliximab"  , 1.68 , 0.10, 1.49  , 1.86  ,
"Rituximab"   , 0.36 , 0.50, -0.72 , 1.27  ,
"Tocilizumab" , 2.20 , 0.14, 1.93  , 2.46  ,
) %>%
  arrange(ordered(trt, levels = levels(cert_net$treatments)))

cert_releff_FE <- as.data.frame(cert_releff_FE)

test_that("FE relative effects", {
  expect_equivalent(cert_releff_FE$mean, tsd_FE$mean, tolerance = tol)
  expect_equivalent(cert_releff_FE$sd, tsd_FE$sd, tolerance = tol)
  expect_equivalent(cert_releff_FE$`2.5%`, tsd_FE$lower, tolerance = tol)
  expect_equivalent(cert_releff_FE$`97.5%`, tsd_FE$upper, tolerance = tol)
})

# RE Relative effects
tsd_RE <- tribble(
~trt          , ~mean, ~sd , ~lower, ~upper,
"CZP"         , 1.83 , 0.24, 1.35  , 2.29  ,
"Adalimumab"  , 2.18 , 0.22, 1.79  , 2.63  ,
"Etanercept"  , 2.04 , 0.46, 1.19  , 2.94  ,
"Infliximab"  , 1.71 , 0.22, 1.30  , 2.16  ,
"Rituximab"   , 0.37 , 0.59, -0.86 , 1.45  ,
"Tocilizumab" , 2.25 , 0.27, 1.75  , 2.79  ,
) %>%
  arrange(ordered(trt, levels = levels(cert_net$treatments)))

cert_releff_RE <- as.data.frame(cert_releff_RE)

test_that("RE relative effects", {
  expect_equivalent(cert_releff_RE$mean, tsd_RE$mean, tolerance = tol)
  expect_equivalent(cert_releff_RE$sd, tsd_RE$sd, tolerance = tol)
  expect_equivalent(cert_releff_RE$`2.5%`, tsd_RE$lower, tolerance = tol)
  expect_equivalent(cert_releff_RE$`97.5%`, tsd_RE$upper, tolerance = tol)
})

# Heterogeneity SD
cert_tau <- as.data.frame(summary(cert_fit_RE, pars = "tau"))

test_that("RE heterogeneity SD", {
  expect_equivalent(cert_tau$mean, 0.19, tolerance = tol)
  expect_equivalent(cert_tau$sd, 0.19, tolerance = tol)
  expect_equivalent(cert_tau$`2.5%`, 0.01, tolerance = tol)
  expect_equivalent(cert_tau$`97.5%`, 0.70, tolerance = tol)
})

# Baseline risk meta-regression
expect_equal(cert_fit_FE$xbar[[".mu"]], -2.421, tolerance = 0.01)
expect_equal(cert_fit_RE$xbar[[".mu"]], -2.421, tolerance = 0.01)

cert_beta_FE <- as.data.frame(summary(cert_fit_FE, pars = "beta"))

test_that("FE baseline risk meta-regression", {
  expect_equal(cert_beta_FE$mean, -0.93, tolerance = tol)
  expect_equal(cert_beta_FE$sd, 0.09, tolerance = tol)
  expect_equal(cert_beta_FE$`2.5%`, -1.03, tolerance = tol)
  expect_equal(cert_beta_FE$`97.5%`, -0.69, tolerance = tol)
})

cert_beta_RE <- as.data.frame(summary(cert_fit_RE, pars = "beta"))

test_that("RE baseline risk meta-regression", {
  expect_equal(cert_beta_RE$mean, -0.95, tolerance = tol)
  expect_equal(cert_beta_RE$sd, 0.10, tolerance = tol)
  expect_equal(cert_beta_RE$`2.5%`, -1.10, tolerance = tol)
  expect_equal(cert_beta_RE$`97.5%`, -0.70, tolerance = tol)
})

# DIC
test_that("FE DIC", {
  expect_equivalent(dic_FE$resdev, 27.3, tolerance = tol_dic)
  expect_equivalent(dic_FE$pd, 19.0, tolerance = tol_dic)
  expect_equivalent(dic_FE$dic, 46.3, tolerance = tol_dic)
})

test_that("RE DIC", {
  expect_equivalent(dic_RE$resdev, 24.2, tolerance = tol_dic)
  expect_equivalent(dic_RE$pd, 19.4, tolerance = tol_dic)
  expect_equivalent(dic_RE$dic, 43.6, tolerance = tol_dic)
})
```
